<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MiniApp Real Estate</title>
  <!-- مكتبة سوبر كي -->
  <script src="https://cdn.marmot-cloud.com/npm/hylid-bridge/2.10.0/index.js"></script>
  <!-- Tailwind للتصميم -->
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>
<body class="bg-gray-100">

  <!-- Navbar -->
  <header class="h-16 w-full bg-stone-700 flex items-center px-4 fixed top-0 left-0 z-10">
    <h1 class="text-2xl font-bold text-white">تطبيق العقارات</h1>
  </header>

  <!-- Main Content -->
  <main class="w-full h-screen flex flex-col items-center gap-4 justify-start p-4 mt-20">
    <!-- أزرار أساسية -->
    <button id="loginBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md">تسجيل الدخول</button>
    <button id="payBtn" class="bg-green-600 text-white px-4 py-2 rounded-md">دفع عام</button>
    <button id="qrBtn" class="bg-purple-600 text-white px-4 py-2 rounded-md">مسح QR</button>

    <p class="text-sm text-gray-700">Auth Code: <span id="authCode"></span></p>
    <p class="text-sm text-gray-700">Token: <span id="token"></span></p>

    <!-- Search -->
    <input id="searchBox" type="text" placeholder="ابحث عن عقار..." 
           class="border px-3 py-2 rounded-md w-64">

    <!-- Property Cards -->
    <div id="properties" class="flex flex-wrap gap-4 mt-4">
      <div class="card bg-white shadow-md p-4 rounded-md w-64" data-name="Baghdad House">
        <h3 class="text-lg font-bold">Baghdad House</h3>
        <p>Price: $120,000</p>
        <button class="bg-green-500 text-white px-3 py-1 rounded-md mt-2"
                onclick="payProperty('Baghdad House')">دفع</button>
        <button class="bg-purple-500 text-white px-3 py-1 rounded-md mt-2"
                onclick="scanPropertyQR('Baghdad House')">QR</button>
      </div>

      <div class="card bg-white shadow-md p-4 rounded-md w-64" data-name="Karada Apartment">
        <h3 class="text-lg font-bold">Karada Apartment</h3>
        <p>Price: $80,000</p>
        <button class="bg-green-500 text-white px-3 py-1 rounded-md mt-2"
                onclick="payProperty('Karada Apartment')">دفع</button>
        <button class="bg-purple-500 text-white px-3 py-1 rounded-md mt-2"
                onclick="scanPropertyQR('Karada Apartment')">QR</button>
      </div>
    </div>
  </main>

  <script>
    let authCode = '';
    let token = '';

    // 1. Authentication
    async function authenticate() {
      try {
        const res = await my.getAuthCode({ scopes: ['auth_base', 'USER_ID'] });
        authCode = res.authCode;
        console.log("AuthCode:", authCode);
        document.getElementById('authCode').textContent = authCode;

        const response = await fetch('https://its.mouamle.space/api/auth-with-superQi', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: authCode })
        });

        const data = await response.json();
        console.log("Auth Response:", data);
        token = data.token;
        document.getElementById('token').textContent = token;

        my.alert({ content: "Login successful" });
      } catch (err) {
        console.error("Auth Error:", err);
        my.alert({ content: "Login failed: " + JSON.stringify(err) });
      }
    }

    // 2. Payment عام
    async function pay() {
      try {
        const response = await fetch('https://its.mouamle.space/api/payment', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          }
        });

        const data = await response.json();
        console.log("Payment Response:", data);

        if (!data.url) {
          my.alert({ content: "Payment failed: no URL returned" });
          return;
        }

        await my.tradePay({
          paymentUrl: data.url,
          success: () => my.alert({ content: "Payment successful" }),
          fail: (err) => {
            console.error("TradePay Error:", err);
            my.alert({ content: "Payment failed: " + JSON.stringify(err) });
          }
        });
      } catch (err) {
        console.error("Payment Error:", err);
        my.alert({ content: "Payment failed: " + JSON.stringify(err) });
      }
    }

    // 2b. دفع عقار محدد
    async function payProperty(property) {
      console.log("Trying to pay for:", property);
      await pay(); // تستعمل نفس الفنكشن العام
    }

    // 3. QR Scanner عام
    async function showQR() {
      try {
        const res = await my.scan({ type: 'qr' });
        console.log("QR Result:", res);
        my.alert({ content: "Scanned QR: " + res.code });
      } catch (err) {
        console.error("QR Error:", err);
        my.alert({ content: "Scan failed: " + JSON.stringify(err) });
      }
    }

    // 3b. QR لعقار محدد
    async function scanPropertyQR(property) {
      console.log("Scanning QR for:", property);
      await showQR();
    }

    // 4. Search
    document.getElementById("searchBox").addEventListener("keyup", function() {
      const query = this.value.toLowerCase();
      const cards = document.querySelectorAll("#properties .card");
      cards.forEach(card => {
        const name = card.getAttribute("data-name").toLowerCase();
        card.style.display = name.includes(query) ? "block" : "none";
      });
    });

    // Event Listeners
    document.getElementById('loginBtn').addEventListener('click', authenticate);
    document.getElementById('payBtn').addEventListener('click', pay);
    document.getElementById('qrBtn').addEventListener('click', showQR);
  </script>
</body>
</html>